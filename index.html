<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæ¥­é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2196F3">
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    #app {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2196F3;
      text-align: center;
      margin-bottom: 30px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #2196F3;
      color: white;
      font-weight: bold;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .checkbox-group label {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .note {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #2196F3;
    }
    button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
    button:hover:not(:disabled) {
      background-color: #1976D2;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .install-prompt {
      background-color: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    .install-prompt button {
      background-color: #4caf50;
      margin-left: 10px;
    }
    .install-prompt button:hover {
      background-color: #45a049;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    @media (max-width: 768px) {
      body { padding: 10px; }
      #app { padding: 15px; }
      table { font-size: 12px; }
      th, td { padding: 6px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="showInstallPrompt" class="install-prompt">
      <span>ğŸ“± ã“ã®æˆæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã¾ã™</span>
      <button @click="installPWA">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
      <button @click="dismissInstallPrompt" style="background-color: #ccc;">å¾Œã§</button>
    </div>

    <h1>ğŸ“š æˆæ¥­é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</h1>
    
    <div v-if="statusMessage" :class="['status', statusType]">
      {{ statusMessage }}
    </div>

    <table>
      <thead>
        <tr>
          <th>æ™‚é™</th>
          <th v-for="day in days" :key="day">{{ day }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(period, pIndex) in periods" :key="period.label">
          <th>{{ period.label }}<br><small>({{ period.start }}ã€œ{{ period.end }})</small></th>
          <td v-for="(day, dIndex) in days" :key="day">
            <div class="checkbox-group">
              <label>
                <input type="checkbox" v-model="schedule[pIndex][dIndex].start">
                å§‹
              </label>
              <label>
                <input type="checkbox" v-model="schedule[pIndex][dIndex].end">
                çµ‚
              </label>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="note">
      <p><strong>ğŸ’¡ ä½¿ã„æ–¹ï¼š</strong></p>
      <ul>
        <li>æˆæ¥­ãŒã‚ã‚‹æ™‚é–“å¸¯ã®ã€Œå§‹ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</li>
        <li>æˆæ¥­çµ‚äº†æ™‚ã«é€šçŸ¥ãŒæ¬²ã—ã„å ´åˆã¯ã€Œçµ‚ã€ã«ã‚‚ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</li>
      </ul>
      
      <label>
        <input type="checkbox" v-model="notifyBefore5Min">
        ğŸ”” 5åˆ†å‰é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
      </label>
      <br><br>
      
      <button @click="startNotification" :disabled="notificationStarted">
        {{ notificationStarted ? 'âœ… é€šçŸ¥é–‹å§‹æ¸ˆã¿' : 'ğŸ”” é€šçŸ¥ã‚’é–‹å§‹' }}
      </button>
      
      <button @click="testNotification" style="background-color: #ff9800; margin-left: 10px;">
        ğŸ§ª é€šçŸ¥ãƒ†ã‚¹ãƒˆ
      </button>
    </div>
  </div>

  <script>
    // Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js')
          .then(function(registration) {
            console.log('SW registered: ', registration);
          })
          .catch(function(registrationError) {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (window.vueApp) {
        window.vueApp.showInstallPrompt = true;
      }
    });

    // Vue.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    const vueApp = new Vue({
      el: '#app',
      data() {
        const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘']
        const periods = [
          { label: '1é™', start: '08:50', end: '10:20' },
          { label: '2é™', start: '10:30', end: '12:00' },
          { label: '3é™', start: '13:00', end: '14:30' },
          { label: '4é™', start: '14:40', end: '16:10' },
          { label: '5é™', start: '16:20', end: '17:50' },
          { label: '6é™', start: '18:00', end: '19:30' }
        ]
        const schedule = periods.map(() =>
          days.map(() => ({ start: false, end: false }))
        )

        return {
          days,
          periods,
          schedule,
          notifyBefore5Min: false,
          notificationStarted: false,
          showInstallPrompt: false,
          statusMessage: '',
          statusType: 'success'
        }
      },
      created() {
        this.loadSchedule()
        window.vueApp = this // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ç”¨
      },
      watch: {
        schedule: {
          handler() {
            this.saveSchedule()
          },
          deep: true
        },
        notifyBefore5Min() {
          this.saveSchedule()
        }
      },
      methods: {
        loadSchedule() {
          try {
            const saved = localStorage.getItem('lessonSchedule')
            if (saved) {
              const data = JSON.parse(saved)
              this.schedule = data.schedule || this.schedule
              this.notifyBefore5Min = data.notifyBefore5Min || false
            }
          } catch (e) {
            console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e)
          }
        },
        saveSchedule() {
          try {
            const data = {
              schedule: this.schedule,
              notifyBefore5Min: this.notifyBefore5Min
            }
            localStorage.setItem('lessonSchedule', JSON.stringify(data))
          } catch (e) {
            console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e)
          }
        },
        showStatus(message, type = 'success') {
          this.statusMessage = message
          this.statusType = type
          setTimeout(() => {
            this.statusMessage = ''
          }, 3000)
        },
        async installPWA() {
          if (deferredPrompt) {
            deferredPrompt.prompt()
            const { outcome } = await deferredPrompt.userChoice
            if (outcome === 'accepted') {
              this.showStatus('ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸï¼', 'success')
            }
            deferredPrompt = null
            this.showInstallPrompt = false
          }
        },
        dismissInstallPrompt() {
          this.showInstallPrompt = false
        },
        startNotification() {
          if (this.notificationStarted) return

          if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                this.beginInterval()
              } else {
                this.showStatus('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error')
              }
            })
          } else if (Notification.permission === 'granted') {
            this.beginInterval()
          } else {
            this.showStatus('é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚', 'error')
          }
        },
        testNotification() {
          if (Notification.permission === 'granted') {
            this.sendNotification('ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥: é€šçŸ¥æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™')
            this.showStatus('ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success')
          } else {
            this.showStatus('é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™', 'error')
          }
        },
        beginInterval() {
          this.notificationStarted = true
          this.showStatus('é€šçŸ¥ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success')
          this.checkTimeAndNotify()
          setInterval(this.checkTimeAndNotify, 60000) // 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        },
        checkTimeAndNotify() {
          const now = new Date()
          const currentDay = now.getDay() - 1 // 0=æœˆ, 4=é‡‘
          if (currentDay < 0 || currentDay > 4) return // åœŸæ—¥ã¯é™¤å¤–

          const pad = num => num.toString().padStart(2, '0')
          const hh = pad(now.getHours())
          const mm = pad(now.getMinutes())
          const currentTime = `${hh}:${mm}`

          this.periods.forEach((period, pIndex) => {
            const startTime = this.notifyBefore5Min ? this.adjustTime(period.start, -5) : period.start
            const endTime = period.end

            if (currentTime === startTime && this.schedule[pIndex][currentDay].start) {
              const message = this.notifyBefore5Min 
                ? `ğŸ”” ${period.label}ã®æˆæ¥­ãŒ5åˆ†å¾Œã«å§‹ã¾ã‚Šã¾ã™`
                : `ğŸ”” ${period.label}ã®æˆæ¥­ãŒå§‹ã¾ã‚Šã¾ã™`
              this.sendNotification(message)
            }
            if (currentTime === endTime && this.schedule[pIndex][currentDay].end) {
              this.sendNotification(`âœ… ${period.label}ã®æˆæ¥­ãŒçµ‚äº†ã—ã¾ã™`)
            }
          })
        },
        adjustTime(timeStr, minutesDiff) {
          const [h, m] = timeStr.split(':').map(Number)
          const date = new Date()
          date.setHours(h)
          date.setMinutes(m + minutesDiff)
          return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`
        },
        sendNotification(message) {
          try {
            new Notification(message, {
              icon: './images/icon.jpg',
              badge: './images/icon.jpg',
              tag: 'lesson-notification',
              requireInteraction: false,
              silent: false
            })
          } catch (e) {
            console.error('é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e)
          }
        }
      }
    })
  </script>
</body>
</html>