<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæ¥­é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2196F3">
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    :root {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border-color: #dddddd;
      --accent-color: #2196F3;
      --accent-hover: #1976D2;
      --success-bg: #d4edda;
      --success-text: #155724;
      --success-border: #c3e6cb;
      --error-bg: #f8d7da;
      --error-text: #721c24;
      --error-border: #f5c6cb;
      --install-bg: #e3f2fd;
      --shadow: rgba(0,0,0,0.1);
    }

    [data-theme="dark"] {
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #2d2d2d;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --border-color: #404040;
      --accent-color: #64b5f6;
      --accent-hover: #42a5f5;
      --success-bg: #1b5e20;
      --success-text: #a5d6a7;
      --success-border: #2e7d32;
      --error-bg: #b71c1c;
      --error-text: #ffcdd2;
      --error-border: #d32f2f;
      --install-bg: #1565c0;
      --shadow: rgba(0,0,0,0.3);
    }

    * { 
      box-sizing: border-box; 
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    #app {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px var(--shadow);
      z-index: 1000;
    }

    .theme-toggle:hover {
      background: var(--accent-hover);
      transform: scale(1.1);
    }

    h1 {
      color: var(--accent-color);
      text-align: center;
      margin-bottom: 30px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      background: var(--bg-secondary);
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: var(--accent-color);
      color: white;
      font-weight: bold;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .checkbox-group label {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
    }

    .note {
      margin-top: 20px;
      padding: 15px;
      background-color: var(--bg-tertiary);
      border-radius: 6px;
      border-left: 4px solid var(--accent-color);
    }

    button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    button:hover:not(:disabled) {
      background-color: var(--accent-hover);
      transform: translateY(-1px);
    }

    button:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .install-prompt {
      background-color: var(--install-bg);
      border: 1px solid var(--accent-color);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      color: var(--text-primary);
    }

    .install-prompt button {
      background-color: #4caf50;
      margin-left: 10px;
    }

    .install-prompt button:hover {
      background-color: #45a049;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }

    .status.success {
      background-color: var(--success-bg);
      color: var(--success-text);
      border: 1px solid var(--success-border);
    }

    .status.error {
      background-color: var(--error-bg);
      color: var(--error-text);
      border: 1px solid var(--error-border);
    }

    .status.warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    [data-theme="dark"] .status.warning {
      background-color: #8b6914;
      color: #fff3cd;
      border: 1px solid #b7791f;
    }

    input[type="checkbox"] {
      accent-color: var(--accent-color);
    }

    label {
      color: var(--text-primary);
    }

    .background-info {
      background-color: var(--bg-tertiary);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .background-info h3 {
      margin-top: 0;
      color: var(--accent-color);
    }

    .sw-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .sw-status.active {
      background-color: var(--success-bg);
      color: var(--success-text);
    }

    .sw-status.inactive {
      background-color: var(--error-bg);
      color: var(--error-text);
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      #app { padding: 15px; }
      table { font-size: 12px; }
      th, td { padding: 6px; }
      .theme-toggle {
        top: 10px;
        right: 10px;
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
    }

    /* ã‚¹ãƒ ãƒ¼ã‚ºãªãƒ†ãƒ¼ãƒåˆ‡æ›¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    html {
      transition: color-scheme 0.3s ease;
    }

    /* ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’è‡ªå‹•æ¤œå‡º */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --bg-tertiary: #2d2d2d;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --border-color: #404040;
        --accent-color: #64b5f6;
        --accent-hover: #42a5f5;
        --success-bg: #1b5e20;
        --success-text: #a5d6a7;
        --success-border: #2e7d32;
        --error-bg: #b71c1c;
        --error-text: #ffcdd2;
        --error-border: #d32f2f;
        --install-bg: #1565c0;
        --shadow: rgba(0,0,0,0.3);
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <button class="theme-toggle" @click="toggleTheme" :title="currentTheme === 'dark' ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿'">
      {{ currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™' }}
    </button>

    <div v-if="showInstallPrompt" class="install-prompt">
      <span>ğŸ“± ã“ã®æˆæ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã¾ã™</span>
      <button @click="installPWA">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
      <button @click="dismissInstallPrompt" style="background-color: #ccc;">å¾Œã§</button>
    </div>

    <h1>ğŸ“š æˆæ¥­é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</h1>

    <div class="background-info">
      <h3>ğŸ”„ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œçŠ¶æ³</h3>
      <p>
        Service Worker: 
        <span :class="['sw-status', serviceWorkerActive ? 'active' : 'inactive']">
          {{ serviceWorkerActive ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–' }}
        </span>
      </p>
      <p v-if="serviceWorkerActive" style="font-size: 14px; color: var(--text-secondary);">
        âœ… ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå‹•ä½œã—ã¾ã™
      </p>
      <p v-else style="font-size: 14px; color: var(--error-text);">
        âš ï¸ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ã€é€šçŸ¥ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
      </p>
    </div>
    
    <div v-if="statusMessage" :class="['status', statusType]">
      {{ statusMessage }}
    </div>

    <table>
      <thead>
        <tr>
          <th>æ™‚é™</th>
          <th v-for="day in days" :key="day">{{ day }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(period, pIndex) in periods" :key="period.label">
          <th>{{ period.label }}<br><small>({{ period.start }}ã€œ{{ period.end }})</small></th>
          <td v-for="(day, dIndex) in days" :key="day">
            <div class="checkbox-group">
              <label>
                <input type="checkbox" v-model="schedule[pIndex][dIndex].start">
                å§‹
              </label>
              <label>
                <input type="checkbox" v-model="schedule[pIndex][dIndex].end">
                çµ‚
              </label>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="note">
      <p><strong>ğŸ’¡ ä½¿ã„æ–¹ï¼š</strong></p>
      <ul>
        <li>æˆæ¥­ãŒã‚ã‚‹æ™‚é–“å¸¯ã®ã€Œå§‹ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</li>
        <li>æˆæ¥­çµ‚äº†æ™‚ã«é€šçŸ¥ãŒæ¬²ã—ã„å ´åˆã¯ã€Œçµ‚ã€ã«ã‚‚ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</li>
        <li><strong>ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œï¼š</strong> é€šçŸ¥é–‹å§‹å¾Œã€ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™</li>
      </ul>
      
      <div style="margin: 15px 0; padding: 15px; background-color: var(--bg-tertiary); border-radius: 6px;">
        <p><strong>ğŸš€ ä¸€æ‹¬è¨­å®šï¼š</strong></p>
        <button @click="setAllStart" style="background-color: #4caf50; margin-right: 10px;">
          ğŸ“š å…¨ã¦æˆæ¥­é–‹å§‹ã®ã¿
        </button>
        <button @click="setAllEnd" style="background-color: #ff9800; margin-right: 10px;">
          âœ… å…¨ã¦æˆæ¥­çµ‚äº†ã®ã¿
        </button>
        <button @click="clearAll" style="background-color: #f44336;">
          ğŸ—‘ï¸ å…¨ã¦ã‚¯ãƒªã‚¢
        </button>
      </div>
      
      <label>
        <input type="checkbox" v-model="notifyBefore5Min">
        ğŸ”” 5åˆ†å‰é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
      </label>
      <br><br>
      
      <button @click="startNotification" :disabled="notificationStarted">
        {{ notificationStarted ? 'âœ… ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥é–‹å§‹æ¸ˆã¿' : 'ğŸ”” ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥ã‚’é–‹å§‹' }}
      </button>
      
      <button @click="stopNotification" v-if="notificationStarted" style="background-color: #f44336; margin-left: 10px;">
        ğŸ›‘ é€šçŸ¥ã‚’åœæ­¢
      </button>
      
      <button @click="testNotification" style="background-color: #ff9800; margin-left: 10px;">
        ğŸ§ª é€šçŸ¥ãƒ†ã‚¹ãƒˆï¼ˆå³åº§ï¼‰
      </button>
      
      <button @click="testDelayedNotification" style="background-color: #9c27b0; margin-left: 10px;">
        â° 1åˆ†å¾Œé€šçŸ¥ãƒ†ã‚¹ãƒˆ
      </button>

      <div v-if="notificationStarted" style="margin-top: 15px; padding: 10px; background-color: var(--success-bg); border-radius: 6px;">
        <p style="margin: 0; color: var(--success-text); font-weight: bold;">
          ğŸ¯ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥ãŒæœ‰åŠ¹ã§ã™
        </p>
        <p style="margin: 5px 0 0 0; color: var(--success-text); font-size: 14px;">
          ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™ã€‚<br>
          ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¤‰æ›´æ™‚ã¯è‡ªå‹•ã§ Service Worker ã«åŒæœŸã•ã‚Œã¾ã™ã€‚
        </p>
      </div>
    </div>
  </div>

  <script>
    // Service Worker ã®ã‚³ãƒ¼ãƒ‰ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ï¼‰
    const SERVICE_WORKER_CODE = `
      const CACHE_NAME = 'lesson-scheduler-v1';
      let scheduleData = null;
      let notificationSettings = { notifyBefore5Min: false };

      // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚
      self.addEventListener('install', (event) => {
        console.log('Service Worker installed');
        self.skipWaiting();
      });

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆæ™‚
      self.addEventListener('activate', (event) => {
        console.log('Service Worker activated');
        event.waitUntil(self.clients.claim());
        
        // å®šæœŸãƒã‚§ãƒƒã‚¯é–‹å§‹
        startPeriodicCheck();
      });

      // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
      self.addEventListener('message', (event) => {
        if (event.data.type === 'UPDATE_SCHEDULE') {
          scheduleData = event.data.schedule;
          notificationSettings = event.data.settings;
          console.log('Schedule updated in Service Worker:', scheduleData);
        } else if (event.data.type === 'START_NOTIFICATIONS') {
          scheduleData = event.data.schedule;
          notificationSettings = event.data.settings;
          startPeriodicCheck();
          console.log('Notifications started in Service Worker');
        } else if (event.data.type === 'STOP_NOTIFICATIONS') {
          stopPeriodicCheck();
          console.log('Notifications stopped in Service Worker');
        }
      });

      let checkInterval = null;

      function startPeriodicCheck() {
        if (checkInterval) clearInterval(checkInterval);
        
        // 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šé »ç¹ã«ï¼‰
        checkInterval = setInterval(() => {
          checkTimeAndNotify();
        }, 30000);
        
        // å³åº§ã«ä¸€åº¦ãƒã‚§ãƒƒã‚¯
        checkTimeAndNotify();
      }

      function stopPeriodicCheck() {
        if (checkInterval) {
          clearInterval(checkInterval);
          checkInterval = null;
        }
      }

      function checkTimeAndNotify() {
        if (!scheduleData) return;

        const now = new Date();
        const currentDay = now.getDay() - 1; // 0=æœˆ, 4=é‡‘
        if (currentDay < 0 || currentDay > 4) return; // åœŸæ—¥ã¯é™¤å¤–

        const periods = [
          { label: '1é™', start: '08:50', end: '10:20' },
          { label: '2é™', start: '10:30', end: '12:00' },
          { label: '3é™', start: '13:00', end: '14:30' },
          { label: '4é™', start: '14:40', end: '16:10' },
          { label: '5é™', start: '16:20', end: '17:50' },
          { label: '6é™', start: '18:00', end: '19:30' }
        ];

        const pad = num => num.toString().padStart(2, '0');
        const hh = pad(now.getHours());
        const mm = pad(now.getMinutes());
        const currentTime = hh + ':' + mm;

        periods.forEach((period, pIndex) => {
          if (!scheduleData[pIndex] || !scheduleData[pIndex][currentDay]) return;

          const startTime = notificationSettings.notifyBefore5Min ? 
            adjustTime(period.start, -5) : period.start;
          const endTime = period.end;

          if (currentTime === startTime && scheduleData[pIndex][currentDay].start) {
            const message = notificationSettings.notifyBefore5Min 
              ? period.label + 'ã®æˆæ¥­ãŒ5åˆ†å¾Œã«å§‹ã¾ã‚Šã¾ã™'
              : period.label + 'ã®æˆæ¥­ãŒå§‹ã¾ã‚Šã¾ã™';
            sendNotification('ğŸ”” ' + message);
          }
          if (currentTime === endTime && scheduleData[pIndex][currentDay].end) {
            sendNotification('âœ… ' + period.label + 'ã®æˆæ¥­ãŒçµ‚äº†ã—ã¾ã™');
          }
        });
      }

      function adjustTime(timeStr, minutesDiff) {
        const parts = timeStr.split(':');
        const h = parseInt(parts[0]);
        const m = parseInt(parts[1]);
        const date = new Date();
        date.setHours(h);
        date.setMinutes(m + minutesDiff);
        const newH = String(date.getHours()).padStart(2, '0');
        const newM = String(date.getMinutes()).padStart(2, '0');
        return newH + ':' + newM;
      }

      function sendNotification(message) {
        self.registration.showNotification(message, {
          icon: './images/icon.jpg',
          badge: './images/icon.jpg',
          tag: 'lesson-notification-' + Date.now(),
          requireInteraction: false,
          silent: false,
          timestamp: Date.now()
        });
      }
    `;

    // Service Worker ã®ãƒ–ãƒ­ãƒ–URLã‚’ä½œæˆ
    const swBlob = new Blob([SERVICE_WORKER_CODE], { type: 'application/javascript' });
    const swURL = URL.createObjectURL(swBlob);

    // ãƒ†ãƒ¼ãƒé–¢é€£ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getInitialTheme() {
      if (typeof localStorage === 'undefined') {
        return 'light';
      }
      
      try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme && (savedTheme === 'light' || savedTheme === 'dark')) {
          return savedTheme;
        }
      } catch (e) {
        console.warn('localStorage access failed:', e);
      }
      
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        return 'dark';
      }
      
      return 'light';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      const themeColorMeta = document.querySelector('meta[name="theme-color"]');
      if (themeColorMeta) {
        themeColorMeta.content = theme === 'dark' ? '#1e1e1e' : '#2196F3';
      }
    }

    const initialTheme = getInitialTheme();
    applyTheme(initialTheme);

    // Service Workerç™»éŒ²
    let serviceWorkerRegistration = null;
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register(swURL)
          .then(function(registration) {
            console.log('SW registered: ', registration);
            serviceWorkerRegistration = registration;
            if (window.vueApp) {
              window.vueApp.serviceWorkerActive = true;
              window.vueApp.serviceWorkerRegistration = registration;
            }
          })
          .catch(function(registrationError) {
            console.log('SW registration failed: ', registrationError);
            if (window.vueApp) {
              window.vueApp.serviceWorkerActive = false;
            }
          });
      });
    }

    // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (window.vueApp) {
        window.vueApp.showInstallPrompt = true;
      }
    });

    // Vue.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    const vueApp = new Vue({
      el: '#app',
      data() {
        const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
        const periods = [
          { label: '1é™', start: '08:50', end: '10:20' },
          { label: '2é™', start: '10:30', end: '12:00' },
          { label: '3é™', start: '13:00', end: '14:30' },
          { label: '4é™', start: '14:40', end: '16:10' },
          { label: '5é™', start: '16:20', end: '17:50' },
          { label: '6é™', start: '18:00', end: '19:30' }
        ];
        const schedule = periods.map(() =>
          days.map(() => ({ start: false, end: false }))
        );

        return {
          days,
          periods,
          schedule,
          notifyBefore5Min: false,
          notificationStarted: false,
          showInstallPrompt: false,
          statusMessage: '',
          statusType: 'success',
          currentTheme: initialTheme,
          testNotificationTime: null,
          testCheckInterval: null,
          serviceWorkerActive: false,
          serviceWorkerRegistration: null
        };
      },
      created() {
        this.loadSchedule();
        this.watchSystemTheme();
        window.vueApp = this;
      },
      beforeDestroy() {
        if (this.testCheckInterval) {
          clearInterval(this.testCheckInterval);
        }
      },
      watch: {
        schedule: {
          handler() {
            this.saveSchedule();
            this.syncWithServiceWorker();
          },
          deep: true
        },
        notifyBefore5Min() {
          this.saveSchedule();
          this.syncWithServiceWorker();
        },
        currentTheme() {
          applyTheme(this.currentTheme);
          this.saveTheme();
        }
      },
      methods: {
        syncWithServiceWorker() {
          if (this.serviceWorkerRegistration && this.serviceWorkerRegistration.active) {
            this.serviceWorkerRegistration.active.postMessage({
              type: 'UPDATE_SCHEDULE',
              schedule: this.schedule,
              settings: { notifyBefore5Min: this.notifyBefore5Min }
            });
          }
        },
        saveTheme() {
          try {
            if (typeof localStorage !== 'undefined') {
              localStorage.setItem('theme', this.currentTheme);
            }
          } catch (e) {
            console.warn('Theme save failed:', e);
          }
        },
        toggleTheme() {
          this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
          this.showStatus(`${this.currentTheme === 'dark' ? 'ãƒ€ãƒ¼ã‚¯' : 'ãƒ©ã‚¤ãƒˆ'}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, 'success');
        },
        watchSystemTheme() {
          if (window.matchMedia) {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', (e) => {
              try {
                const savedTheme = localStorage.getItem('theme');
                if (!savedTheme) {
                  this.currentTheme = e.matches ? 'dark' : 'light';
                }
              } catch (error) {
                this.currentTheme = e.matches ? 'dark' : 'light';
              }
            });
          }
        },
        loadSchedule() {
          try {
            if (typeof localStorage !== 'undefined') {
              const saved = localStorage.getItem('lessonSchedule');
              if (saved) {
                const data = JSON.parse(saved);
                this.schedule = data.schedule || this.schedule;
                this.notifyBefore5Min = data.notifyBefore5Min || false;
                this.notificationStarted = data.notificationStarted || false;
              }
            }
          } catch (e) {
            console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          }
        },
        saveSchedule() {
          try {
            if (typeof localStorage !== 'undefined') {
              const data = {
                schedule: this.schedule,
                notifyBefore5Min: this.notifyBefore5Min,
                notificationStarted: this.notificationStarted
              };
              localStorage.setItem('lessonSchedule', JSON.stringify(data));
            }
          } catch (e) {
            console.error('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
          }
        },
        showStatus(message, type = 'success') {
          this.statusMessage = message;
          this.statusType = type;
          setTimeout(() => {
            this.statusMessage = '';
          }, 4000);
        },
        async installPWA() {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
              this.showStatus('ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸï¼', 'success');
            }
            deferredPrompt = null;
            this.showInstallPrompt = false;
          }
        },
        dismissInstallPrompt() {
          this.showInstallPrompt = false;
        },
        async startNotification() {
          if (this.notificationStarted) return;

          if (!this.serviceWorkerActive) {
            this.showStatus('Service WorkerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
          }

          if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
              this.showStatus('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error');
              return;
            }
          } else if (Notification.permission !== 'granted') {
            this.showStatus('é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚', 'error');
            return;
          }

          this.notificationStarted = true;
          this.saveSchedule();
          
          // Service Workerã«é€šçŸ¥é–‹å§‹ã‚’ä¼ãˆã‚‹
          if (this.serviceWorkerRegistration && this.serviceWorkerRegistration.active) {
            this.serviceWorkerRegistration.active.postMessage({
              type: 'START_NOTIFICATIONS',
              schedule: this.schedule,
              settings: { notifyBefore5Min: this.notifyBefore5Min }
            });
          }

          this.showStatus('ğŸ¯ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™ã€‚', 'success');
        },
        stopNotification() {
          this.notificationStarted = false;
          this.saveSchedule();
          
          // Service Workerã«é€šçŸ¥åœæ­¢ã‚’ä¼ãˆã‚‹
          if (this.serviceWorkerRegistration && this.serviceWorkerRegistration.active) {
            this.serviceWorkerRegistration.active.postMessage({
              type: 'STOP_NOTIFICATIONS'
            });
          }

          this.showStatus('é€šçŸ¥ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
        },
        setAllStart() {
          this.schedule.forEach(periodRow => {
            periodRow.forEach(daySlot => {
              daySlot.start = true;
              daySlot.end = false;
            });
          });
          this.showStatus('å…¨ã¦ã®æ™‚é–“å¸¯ã§æˆæ¥­é–‹å§‹é€šçŸ¥ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
        },
        setAllEnd() {
          this.schedule.forEach(periodRow => {
            periodRow.forEach(daySlot => {
              daySlot.start = false;
              daySlot.end = true;
            });
          });
          this.showStatus('å…¨ã¦ã®æ™‚é–“å¸¯ã§æˆæ¥­çµ‚äº†é€šçŸ¥ã‚’è¨­å®šã—ã¾ã—ãŸ', 'success');
        },
        clearAll() {
          this.schedule.forEach(periodRow => {
            periodRow.forEach(daySlot => {
              daySlot.start = false;
              daySlot.end = false;
            });
          });
          this.showStatus('å…¨ã¦ã®è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        },
        testNotification() {
          if (Notification.permission === 'granted') {
            this.sendNotification('ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥: é€šçŸ¥æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
            this.showStatus('ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
          } else {
            this.showStatus('é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™', 'error');
          }
        },
        testDelayedNotification() {
          if (Notification.permission === 'granted') {
            const now = new Date();
            const testTime = new Date(now.getTime() + 60000); // 1åˆ†å¾Œ
            const timeStr = `${String(testTime.getHours()).padStart(2, '0')}:${String(testTime.getMinutes()).padStart(2, '0')}`;
            
            // æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (this.testCheckInterval) {
              clearInterval(this.testCheckInterval);
            }
            
            this.testNotificationTime = testTime;
            this.showStatus(`1åˆ†å¾Œï¼ˆ${timeStr}ï¼‰ã«é€šçŸ¥ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™`, 'success');
            
            // 10ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯é–‹å§‹
            this.testCheckInterval = setInterval(() => {
              this.checkTestNotification();
            }, 10000);
            
            // 2åˆ†å¾Œã«è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            setTimeout(() => {
              if (this.testCheckInterval) {
                clearInterval(this.testCheckInterval);
                this.testCheckInterval = null;
                this.testNotificationTime = null;
              }
            }, 120000);
          } else {
            this.showStatus('é€šçŸ¥è¨±å¯ãŒå¿…è¦ã§ã™', 'error');
          }
        },
        checkTestNotification() {
          if (!this.testNotificationTime) return;
          
          const now = new Date();
          const targetTime = this.testNotificationTime;
          
          // æ™‚åˆ»ãŒä¸€è‡´ã—ãŸå ´åˆï¼ˆåˆ†å˜ä½ã§æ¯”è¼ƒï¼‰
          if (now.getHours() === targetTime.getHours() && 
              now.getMinutes() === targetTime.getMinutes()) {
            
            this.sendNotification('â° 1åˆ†å¾Œé€šçŸ¥ãƒ†ã‚¹ãƒˆ: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é€šçŸ¥æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
            this.showStatus('1åˆ†å¾Œé€šçŸ¥ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼', 'success');
            
            // ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            clearInterval(this.testCheckInterval);
            this.testCheckInterval = null;
            this.testNotificationTime = null;
          }
        },
        sendNotification(message) {
          try {
            new Notification(message, {
              icon: './images/icon.jpg',
              badge: './images/icon.jpg',
              tag: 'lesson-notification',
              requireInteraction: false,
              silent: false
            });
          } catch (e) {
            console.error('é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
      }
    });
  </script>
</body>
</html>