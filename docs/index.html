<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>授業通知スケジューラー</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
      text-align: center;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .note {
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>授業通知スケジューラー</h1>
    <table>
      <thead>
        <tr>
          <th>時限</th>
          <th v-for="day in days" :key="day">{{ day }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(period, pIndex) in periods" :key="period.label">
          <th>{{ period.label }}<br>({{ period.start }}〜{{ period.end }})</th>
          <td v-for="(day, dIndex) in days" :key="day">
            <div class="checkbox-group">
              <label>始 <input type="checkbox" v-model="schedule[pIndex][dIndex].start"></label>
              <label>終 <input type="checkbox" v-model="schedule[pIndex][dIndex].end"></label>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="note">
      <p>※授業開始時のみチェックを入れる</p>
      <label>5分前通知 <input type="checkbox" v-model="notifyBefore5Min"></label>
      <br>
      <button @click="startNotification" :disabled="notificationStarted">通知開始</button>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data() {
        const days = ['月', '火', '水', '木', '金']
        const periods = [
          { label: '1限', start: '08:50', end: '10:20' },
          { label: '2限', start: '10:30', end: '12:00' },
          { label: '3限', start: '13:00', end: '14:30' },
          { label: '4限', start: '14:40', end: '16:10' },
          { label: '5限', start: '16:20', end: '17:50' },
          { label: '6限', start: '18:00', end: '19:30' }
        ]
        const schedule = periods.map(() =>
          days.map(() => ({ start: false, end: false }))
        )

        return {
          days,
          periods,
          schedule,
          notifyBefore5Min: false,
          notificationStarted: false
        }
      },
      created() {
        const saved = localStorage.getItem('lessonSchedule')
        if (saved) {
          const data = JSON.parse(saved)
          this.schedule = data.schedule
          this.notifyBefore5Min = data.notifyBefore5Min
        }
      },
      watch: {
        schedule: {
          handler() {
            this.saveSchedule()
          },
          deep: true
        },
        notifyBefore5Min() {
          this.saveSchedule()
        }
      },
      methods: {
        saveSchedule() {
          const data = {
            schedule: this.schedule,
            notifyBefore5Min: this.notifyBefore5Min
          }
          localStorage.setItem('lessonSchedule', JSON.stringify(data))
        },
        startNotification() {
          if (this.notificationStarted) return

          if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                this.beginInterval()
              }
            })
          } else if (Notification.permission === 'granted') {
            this.beginInterval()
          } else {
            alert('通知がブロックされています。ブラウザの設定をご確認ください。')
          }
        },
        beginInterval() {
          this.notificationStarted = true
          this.checkTimeAndNotify()
          setInterval(this.checkTimeAndNotify, 60000)
        },
        checkTimeAndNotify() {
          const now = new Date()
          const currentDay = now.getDay() - 1 // 0=月, 4=金
          if (currentDay < 0 || currentDay > 4) return

          const pad = num => num.toString().padStart(2, '0')
          const hh = pad(now.getHours())
          const mm = pad(now.getMinutes())
          const currentTime = `${hh}:${mm}`

          this.periods.forEach((period, pIndex) => {
            const startTime = this.notifyBefore5Min ? this.adjustTime(period.start, -5) : period.start
            const endTime = period.end

            if (currentTime === startTime && this.schedule[pIndex][currentDay].start) {
              this.sendNotification(`${period.label}の授業が${this.notifyBefore5Min ? '5分後に' : ''}始まります`)
            }
            if (currentTime === endTime && this.schedule[pIndex][currentDay].end) {
              this.sendNotification(`${period.label}の授業が終了します`)
            }
          })
        },
        adjustTime(timeStr, minutesDiff) {
          const [h, m] = timeStr.split(':').map(Number)
          const date = new Date()
          date.setHours(h)
          date.setMinutes(m + minutesDiff)
          return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`
        },
        sendNotification(message) {
          new Notification(message, {
            icon: './images/icon.jpg'
          })
        }
      }
    })
  </script>
</body>
</html>
